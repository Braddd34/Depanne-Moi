// Neon PostgreSQL
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String?  // null si magic link
  name      String
  company   String?
  phone     String
  vehicleType String? // "camion", "remorque", etc.
  role      UserRole @default(USER)
  
  // RGPD - Conformité UE
  emailConsent     Boolean  @default(true)  // Consentement pour recevoir des emails transactionnels
  acceptedTerms    Boolean  @default(false) // Acceptation des CGU et politique de confidentialité
  acceptedTermsAt  DateTime? // Date d'acceptation des CGU
  
  // Vérification d'identité (Didit.me)
  isVerified          Boolean  @default(false)      // Identité vérifiée
  identityVerifiedAt  DateTime?                    // Date de vérification identité
  driverLicenseVerified Boolean @default(false)    // Permis vérifié
  businessVerified    Boolean  @default(false)      // KBIS vérifié (entreprise)
  verificationLevel   VerificationLevel @default(NONE) // Niveau de vérification
  diditSessionId      String?                      // ID session Didit.me
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  trips     Trip[]
  bookings  Booking[]
  verificationSessions VerificationSession[]
  reviewsGiven    Review[] @relation("ReviewsGiven")
  reviewsReceived Review[] @relation("ReviewsReceived")
  
  @@map("users")
}

model VerificationSession {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  sessionId       String   @unique  // ID session Didit.me
  sessionUrl      String              // URL de vérification Didit
  verificationType String              // "identity", "driver_license", "business"
  
  status          VerificationStatus @default(PENDING)
  result          Json?                // Résultats Didit (JSON)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  completedAt     DateTime?
  
  @@map("verification_sessions")
}

model Trip {
  id          String   @id @default(cuid())
  driverId    String
  driver      User     @relation(fields: [driverId], references: [id], onDelete: Cascade)
  
  fromCity    String
  toCity      String
  date        DateTime
  vehicleType String   // Type de véhicule transportable
  price       Float?   // Prix indicatif (optionnel)
  
  status      TripStatus @default(AVAILABLE)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  bookings   Booking[]
  reviews    Review[]
  
  @@map("trips")
}

model Booking {
  id        String   @id @default(cuid())
  tripId    String
  trip      Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)
  
  bookerId  String
  booker    User     @relation(fields: [bookerId], references: [id], onDelete: Cascade)
  
  status    BookingStatus @default(PENDING)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("bookings")
}

enum TripStatus {
  AVAILABLE
  RESERVED
  COMPLETED
  CANCELLED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
}

model Review {
  id              String   @id @default(cuid())
  
  // L'utilisateur qui donne l'avis
  reviewerId      String
  reviewer        User     @relation("ReviewsGiven", fields: [reviewerId], references: [id], onDelete: Cascade)
  
  // L'utilisateur qui reçoit l'avis
  reviewedUserId  String
  reviewedUser    User     @relation("ReviewsReceived", fields: [reviewedUserId], references: [id], onDelete: Cascade)
  
  // Le trajet concerné
  tripId          String
  trip            Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)
  
  // Notation et commentaire
  rating          Int      // 1-5 étoiles
  comment         String?  // Commentaire optionnel
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Un utilisateur ne peut laisser qu'un seul avis par trajet
  @@unique([reviewerId, tripId])
  @@map("reviews")
}

enum UserRole {
  USER
  ADMIN
}

enum VerificationLevel {
  NONE           // Pas encore vérifié
  IDENTITY       // Identité vérifiée (CNI/Passeport)
  DRIVER         // Identité + Permis
  BUSINESS       // Identité + KBIS (entreprise)
  FULL           // Identité + Permis + KBIS
}

enum VerificationStatus {
  PENDING        // En attente
  IN_PROGRESS    // En cours
  COMPLETED      // Terminée avec succès
  FAILED         // Échec
  EXPIRED        // Session expirée
}
