generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
}

enum TripStatus {
  AVAILABLE
  RESERVED
  COMPLETED
  CANCELLED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
}

enum NotificationType {
  BOOKING_REQUEST
  BOOKING_CONFIRMED
  BOOKING_CANCELLED
  TRIP_UPDATED
  MESSAGE_RECEIVED
  REVIEW_RECEIVED
  SYSTEM
}

model User {
  id          String   @id @default(cuid())
  email       String   @unique
  password    String?
  name        String
  company     String?
  phone       String
  vehicleType String?
  role        UserRole @default(USER)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  trips               Trip[]        @relation("UserTrips")
  bookings            Booking[]     @relation("UserBookings")
  reviewsGiven        Review[]      @relation("ReviewerRelation")
  reviewsReceived     Review[]      @relation("ReviewedUserRelation")
  notifications       Notification[]
  sentMessages        Message[]     @relation("SentMessages")
  conversationsAsUser1 Conversation[] @relation("User1Conversations")
  conversationsAsUser2 Conversation[] @relation("User2Conversations")

  @@map("users")
}

model Trip {
  id          String     @id @default(cuid())
  driverId    String
  fromCity    String
  toCity      String
  date        DateTime
  vehicleType String
  price       Float?
  status      TripStatus @default(AVAILABLE)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations
  driver   User      @relation("UserTrips", fields: [driverId], references: [id], onDelete: Cascade)
  bookings Booking[]
  reviews  Review[]

  @@map("trips")
}

model Booking {
  id        String        @id @default(cuid())
  tripId    String
  userId    String        @map("bookerId")
  status    BookingStatus @default(PENDING)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  // Relations
  trip Trip @relation(fields: [tripId], references: [id], onDelete: Cascade)
  user User @relation("UserBookings", fields: [userId], references: [id], onDelete: Cascade)

  @@map("bookings")
}

model Review {
  id             String   @id @default(cuid())
  reviewerId     String
  reviewedUserId String
  tripId         String
  rating         Int
  comment        String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  reviewer     User @relation("ReviewerRelation", fields: [reviewerId], references: [id], onDelete: Cascade)
  reviewedUser User @relation("ReviewedUserRelation", fields: [reviewedUserId], references: [id], onDelete: Cascade)
  trip         Trip @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@unique([reviewerId, tripId])
  @@map("reviews")
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  link      String?
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@map("notifications")
}

model Conversation {
  id        String   @id @default(cuid())
  user1Id   String
  user2Id   String
  lastMessageAt DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user1    User      @relation("User1Conversations", fields: [user1Id], references: [id], onDelete: Cascade)
  user2    User      @relation("User2Conversations", fields: [user2Id], references: [id], onDelete: Cascade)
  messages Message[]

  @@unique([user1Id, user2Id])
  @@index([user1Id])
  @@index([user2Id])
  @@map("conversations")
}

model Message {
  id             String   @id @default(cuid())
  conversationId String
  senderId       String
  content        String
  read           Boolean  @default(false)
  createdAt      DateTime @default(now())

  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
  @@map("messages")
}
